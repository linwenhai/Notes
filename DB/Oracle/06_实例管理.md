## Oracle实例管理

### 1 实例启动与关闭

```bash
$ sqlplus /nolog



 



SQL> connect sys/**** as sysdba;



SQL> startup nomount;            --nomount模式加载参数文件和警告日志



SQL> alter database mount;       --mount模式加载控制文件



SQL> alter database open;        --open模式加载数据文件和联机重做日志



 



SQL> shutdown immediate;



SQL> startup;



SQL> shutdown abort;
```

 

### 2 Database control

```bash
$ cd $ORACLE_HOME/bin



$ emctl start dbconsole



$ emctl stop dbconsole



$ emctl status dbconsole
```

  --相关的3个环境变量PATH,ORALCE_HOME,ORACLE_SID

URL: https://machine_name:port/em

**1】创建OEM**

```bash
$ set ORACLE_SID=oranc
```

配置hosts文件

 

**2】首次创建的步骤**

```bash
$ emca -repos create



$ emca -config dbcontrol db



$ emctl start dbconsole
```

 

**3】重新配置的步骤**

```bash
$ emca -repos drop



$ emca -repos create



$ emca -config dbcontrol db



$ emctl start dbconsole
```

已成功完成 Enterprise Manager 的配置

 

### 3 pfile与spfile

**1】创建spfile或pfile**

```sql
SQL> create spfile[='spfilename'] from pfile[='pfilename'];



SQL> create pfile[='pfilename'] from spfile[='spfilename'];
```

 

**2】使用pfile文件启动实例**

```sql
SQL> startup pfile[='pfilename'];
```

 

**3】initoranc.ora**

```
*.audit_file_dest='/u01/app/admin/oranc/adump'



*.audit_sys_operations=TRUE



*.audit_trail='DB_EXTENDED'



*.compatible='11.2.0.0.0'



*.control_files='/oradata/oranc/control01.ctl','/u01/app/fast_recovery_area/oranc/control02.ctl'



*.db_block_size=8192



*.db_domain=''



*.db_name='oranc'



*.db_recovery_file_dest='/u01/app/fast_recovery_area'



*.db_recovery_file_dest_size=5218762752



*.diagnostic_dest='/u01/app'



*.dispatchers='(PROTOCOL=TCP) (SERVICE=orancXDB)'



*.open_cursors=300



*.pga_aggregate_target=300M



*.processes=150



*.remote_login_passwordfile='EXCLUSIVE'



*.sga_max_size=1024M



*.sga_target=1024M



*.undo_tablespace='UNDOTBS1'
```

 

### 4 Parameter

**1]】pfile与spfile默认的参数文件路径**

```
-----linux环境------------



$ ORACLE_HOME/dbs/spfileSID.ora



$ ORACLE_HOME/dbs/pfile.ora



$ ORACLE_HOME/dbs/initSID.ora
--------windows环境-------------



%ORACLE_HOME%\database\SPFILESID.ORA



%ORACLE_HOME%\database\SPFILE.ORA



%ORACLE_HOME%\database\INITSID.ORA
```

 

**2】常用初始化参数**

| 常用初始化参数 |                             |                                                  |
| -------------- | --------------------------- | ------------------------------------------------ |
| 1              | cluster_database            | 说明是RAC还是单实例                              |
| 2              | compatible                  | 实例将要模仿的版本                               |
| 3              | control_files               | 控制文件名称与路径                               |
| 4              | db_block_size               | 块大小                                           |
| 5              | db_create_file_dest         | 数据文件默认路径                                 |
| 6              | db_create_online_log_dest   | 联机重做日志文件默认路径                         |
| 7              | db_domain                   | 全局名称                                         |
| 8              | db_name                     | 当前实例名                                       |
| 9              | db_recovery_file_dest       | 闪回区域路径                                     |
| 10             | db_recovery_file_dest_size  | 闪回区域大小                                     |
| 11             | db_unique_name              | 当前实例名的唯一标识符                           |
| 12             | instance_number             | *后续跟进RAC设置*                                |
| 13             | job_queue_processes         | 运行调度作业的可用进程数                         |
| 14             | log_archive_dest            | 归档重做日志文件路径                             |
| 15             | log_archive_dest_state      | 提示是否启用了目标                               |
| 16             | nls_language                | 实例语言                                         |
| 17             | nls_territory               | 实例地理位置                                     |
| 18             | open_cursors                | 会话一次可以打开SQL工作区域数量                  |
| 19             | pga_aggregate_target        | PGA内存大小                                      |
| 20             | processes                   | 连接到实例的最大进程数                           |
| 21             | remote_listener             | 当前实例注册到另一台计算机的侦听器地址           |
| 22             | remote_login_passwordfile   | 是否使用外部口令文件                             |
| 23             | sessions                    | 连接到实例的最大会话数                           |
| 24             | sga_target                  | SGA内存大小                                      |
| 25             | shared_servers              | 要启动的共享服务器进程数量                       |
| 26             | star_transformation_enabled | 是否允许优化器重写将事实表的维度连接在一起的查询 |
| 27             | undo_management             | 撤销表空间管理模式                               |
| 28             | undo_tablespace             | 撤销表空间名                                     |

sessions=(1.1*processes)+5

 

**3】查看常用初始化参数**

```sql
show parameter processes;
```

 

**4】查看隐藏参数**

```sql
select x.ksppinm name, y.ksppstvl value, x.ksppdesc descriptoin



from x$ksppi x, x$ksppcv y



where x.inst_id= userenv('Instance') 



and y.inst_id= userenv ('Instance') 



and x.indx = y.indx



and x.ksppinm like '_allow_resetlogs_%';
```

 

**5】 修改初始化参数**

```sql
alter system set processes=1000 scope=spfile;



    --scope3个参数：memory,spfile,both



 



alter  system set "_optimizer_extended_cursor_sharing_rel"='NONE' scope=both;



    --修改隐藏参数



 



alter system set open_cursors=1000 sid=’*’ scope=spfile;



    --RAC环境,修改所有实例
```

 

**6】 open_cursors**

查看系统open_cursors曾达到最大值和设置值：

```sql
select max(a.value) as highest_open_cur,p.value as max_open_cur



from v$sesstat a ,v$statname b,v$parameter p



where a.statistic#=b.statistic# 



and b.name='opened cursors current' 



and p.name='open_cursors'



group by p.value;
```

 

**7】 session_cached_cursors**

```sql
select name,value from v$sysstat where name like '%cursor%';



select name,value from v$sysstat where name like '%parse%';



    --查看session cursor cache hits与parse count (total)比例
```

 

### 5 Redo log

```sql
select * from v$logfile;



select * from v$log;
```

改变向量(change vector)
  改变向量表示对数据库内某一个数据块所做的一次变更。
重做记录(redo record)
  重做记录通常由一组改变向量组成，是一个改变向量的集合，代表一个数据库的变更，构成数据库变更的最小恢复单位。

 

**1】 redo****写的触发条件**

- 每3秒超时
- redo log buffer 1/3满
- redo log buffer具有1MB脏数据

 ------通常建议设置log buffer为3MB大小

 

**2】log_buffer****参数调整参考**

```sql
select event#,name from v$event_name where name='log buffer space';
```

 

**3】redo log****状态**

- ACTIVE     --活动的非当前日志文件,可能完成归档，也可能没有归档
- INACTIVE   --非活动日志
- UNUSED   --日志从未被写入

 

**4】****丢失****INACTIVE****日志组恢复**

```sql
startup mount;



alter database clear logfile group 2;
```

 

**5】** **丢失****CURRENT****日志组恢复****,** **数据库正常关闭**

```sql
startup mount;



alter database clear unarchived logfile group 1;  
```

 

**6】** **丢失****CURRENT****日志组恢复****,** **数据库异常关闭**

使用MRAN恢复

 

**7】** **联机重做日志多路复用****:**

```sql
alter database add logfile group 4 ('/u01/oradata/oranc/redo04.log') size 100M;     



------在线增加redo log组



 



alter database add logfile member  '/u01/oradata/oranc/redo01b.log' to group 1;  



------在线增加redo log组成员
```

 

**8】** **删除组****/****成员**

```sql
alter database drop logfile group 4;



    --在线删除组,只能删除日志组状态为 INACTIVE 的日志组,需手工删除OS上文件



 



alter database drop logfile member '/u01/oradata/oranc/redo01b.log';



    --在线删除成员
```

 

**9】** **强制执行日志切换**

```sql
alter system switch logfile;
```

 

**10】****强制检查点位置进入最新状态**

```sql
alter system checkpoint;
```

 

### 6 Archivelog

```
SQL> archive log list;         --查看归档状态



RMAN> list archivelog all;     --查看归档日志



 



SQL> alter system switch logfile;



    --对单实例或RAC中的当前实例日志切换，归档重做日志（需启动日志归档）



 



SQL> alter system archive log current;



    --对所有实例日志切换，归档重做日志
```

 

**1】** **归档日志路径修改，多路复用**

```
SQL> show parameter log_archive_dest;



SQL> alter system set log_archive_dest_1='LOCATION=/u01/archivelog01' scope=spfile;



SQL> alter system set log_archive_dest_2='LOCATION=/u01/archivelog02' scope=spfile;



SQL> alter system set log_archive_format='archive_%t_%s_%r.dbf' scope=spfile;



SQL> shutdown immediate;



SQL> startup;
```

 

**2]** **开启归档模式**

```
SQL> shutdown immediate;



SQL> startup mount;



SQL> alter database archivelog;



SQL> alter database open;



SQL> alter system set log_archive_dest_1='LOCATION=/u01/archivelog01' scope=both;



SQL> alter system switch logfile;



SQL> archive log list;
```

 

**3]** **关闭归档模式**

```
SQL> shutdown immediate;



SQL> startup mount;



SQL> alter database noarchivelog;



SQL> alter database open;



SQL> archive log list;
```

 

**4]** **手工删除归档日志后，需清除****controlfile****记录**

```
RMAN> crosscheck archivelog all;



RMAN> delete expired archivelog all;
```

 

**5]** **正确删除归档日志**

```
RMAN> delete archivelog all completed before ‘SYSDATE-7’;



    -----删除系统时间7天前日志



 



RMAN> delete archivelog all;



    -----删除所有归档日志
```

 

### 7 Controlfile

```
SQL> select * from v$controlfile;



SQL> show parameter control_files;
```

 

**1】控制文件多路复用**

```
SQL> shutdown immediate;



$ cp /u01/oradata/oranc/control01.ctl /u01/oradata/oranc/control03.ctl



SQL>startup nomount;



SQL> 



alter system set



control_files=”/u01/oradata/oranc/control01.ctl”,



“/u01/oradata/oranc/control03.ctl”,



“/u01/fast_recovery_area/oranc/control02.ctl”



scope=spfile;       



SQL> startup force;
```

 

**2】 SCN**

```
SCN: system change number



SQL> select dbms_flashback.get_system_change_number from dual;



    --查看当前或最近SCN
```

 

 

### 8 告警日志

```
SQL> show parameter background_dump_dest;



    --警报日志路径，名为aler_SID.log
```

**1】日志清理**

先备份，后清空

```
$ du -m alter_oranc.log



$ echo "" > alter_oranc.log



$ echo "" > liseneter.log







SQL> select * from v$diag_info;







$ oerr ora 27142



    --Linux/Unix查看ORA错误
```

 

 

### 9 口令文件

缺省路径为：$ORACLE_HOME/dbs

缺省名称为：orapw<sid>

**1】oracle口令文件的创建**

```
orapwd file=<fname> password=<password> entries=<users> force=<y/n> nosysdba=<y/n>







说明



file  创建的密码文件



password  创建的口令（sys用户）



entries=MAX_USER  口令文件中可以存放的最大用户数。即拥有sysdba和sysoper身份登陆的用户数



force=(Y/N) 强制覆盖已存在的密码文件



nosysdba=<y/n> sysdba用户不可以登陆
```

 

**2】例：**

```
$ orapwd file=$ORACLE_HOME/dbs/orapwdoranc password=111qqq entries=5 force=y
```

 

### 10 AWR

**1】 生产快照**

```
$ sqlplus / as sysdba



SQL> exec DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT (flush_level=>'ALL');
```

**2】 运行awrrpt.sql**

```
$ cd $ORACLE_HOME/rdbms/admin



$ sqlplus / as sysdba



SQL> @awrrpt.sql



 



Enter value for report_type: html           ----输入类型



Enter value for num_days: 2                 ----输入天数



Enter value for begin_snap: 200    ----输入开始值与结束值



Enter value for end_snap: 214



Enter value for report_name: /home/oracle/awr_2013-3-7.html    ----输入导出表的名称
```

 

### 11 oerr

oerr ora 错误编号

例如要查看ora-01632的描述：

```
$ oerr ora 01632
```

01632, 00000, "max # extents (%s) reached in index %s.%s"
// *Cause: An index tried to extend past maxextents
// *Action: If maxextents is less than the system max, raise it. Otherwise,
//     you must recreate with larger initial, next or pctincrease params.

 

### 12 字符集

查询oracle server端的字符集

```
SQL> select userenv('language') from dual;
```

客户端字符集设置方法

**1】UNIX环境**

```
$ NLS_LANG=“simplified chinese”_china.zhs16gbk



$ export NLS_LANG
```

**2】Windows环境**

```
编辑注册表



	Regedit.exe ---》 HKEY_LOCAL_MACHINE ---》SOFTWARE ---》 ORACLE--》HOME



或者在窗口设置：



	set nls_lang=AMERICAN_AMERICA.ZHS16GBK
```

SIMPLIFIED CHINESE_CHINA.AL32UTF8
AMERICAN_AMERICA.AL32UTF8  
SIMPLIFIED CHINESE_CHINA.ZHS16GBK

 

 

### 13 Undo

**undo 记录信息：**

- 对于insert操作，回滚段只需记录插入记录的rowid，如回退，只需将该记录根据rowid删除即可；
- 对于update操作，回滚段只需记录被更新字段的旧值（前镜像），回退时通过旧值覆盖新值即可；
- 对于delete操作，则需记录整行数据，回退时通过一个反向操作恢复删除的数据；
- undo_tablespace
- undo_management
- undo_retention    --设置撤销保留时间的大小

 

### 14 连接远程数据库

**1】 sqlplus连接远程数据库**

Sqlplus user/pass@service

如：$ sqlplus nc8401/*****@ORA83

 

```
---------tnsnames.ora文件设置----------



ORA83 =



  (DESCRIPTION =



    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.28.1.83)(PORT = 1521))



    (CONNECT_DATA =



      (SERVER = DEDICATED)



      (SERVICE_NAME = oranc)



    )



  )
```

 