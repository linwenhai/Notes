## 搜索文档



### 1 测试数据

```json
POST _bulk
{ "create" : { "_index" : "twitter", "_id": 1} }
{"user":"双榆树-张三","message":"今儿天气不错啊，出去转转去","uid":2,"age":20,"city":"北京","province":"北京","country":"中国","address":"中国北京市海淀区","location":{"lat":"39.970718","lon":"116.325747"}}
{ "index" : { "_index" : "twitter", "_id": 2 }}
{"user":"东城区-老刘","message":"出发，下一站云南！","uid":3,"age":30,"city":"北京","province":"北京","country":"中国","address":"中国北京市东城区台基厂三条3号","location":{"lat":"39.904313","lon":"116.412754"}}
{ "index" : { "_index" : "twitter", "_id": 3} }
{"user":"东城区-李四","message":"happy birthday!","uid":4,"age":30,"city":"北京","province":"北京","country":"中国","address":"中国北京市东城区","location":{"lat":"39.893801","lon":"116.408986"}}
{ "index" : { "_index" : "twitter", "_id": 4} }
{"user":"朝阳区-老贾","message":"123,gogogo","uid":5,"age":35,"city":"北京","province":"北京","country":"中国","address":"中国北京市朝阳区建国门","location":{"lat":"39.718256","lon":"116.367910"}}
{ "index" : { "_index" : "twitter", "_id": 5} }
{"user":"朝阳区-老王","message":"Happy BirthDay My Friend!","uid":6,"age":50,"city":"北京","province":"北京","country":"中国","address":"中国北京市朝阳区国贸","location":{"lat":"39.918256","lon":"116.467910"}}
{ "index" : { "_index" : "twitter", "_id": 6} }
{"user":"虹桥-老吴","message":"好友来了都今天我生日，好友来了,什么 birthday happy 就成!","uid":7,"age":90,"city":"上海","province":"上海","country":"中国","address":"中国上海市闵行区","location":{"lat":"31.175927","lon":"121.383328"}}
```



### 2 math查询

match query知道分词器的存在，会对filed进行分词操作，然后再查询。

```json
# 使用match query时，默认的操作是 OR
# 匹配：“朝”，“阳”，“区”，“老”及“贾”这5个字中的任何一个都显示
GET twitter/_search
{
 "query": {
   "match": {
     "user": "朝阳区-老贾"
   }
 }
}

GET twitter/_search
{
  "query": {
    "match": {
      "user": {
        "query": "朝阳区-老贾",
        "operator": "or"
      }
    }
  }
}
```



```json
# "operator": "and"精准匹配
GET twitter/_search
{
  "query": {
    "match": {
      "user": {
        "query": "朝阳区-老贾",
        "operator": "and"
      }
    }
  }
}
```



### 3 multi_match查询

```json
# 搜索多个字段
GET twitter/_search
{
  "query": {
    "multi_match": {
      "query": "朝阳",
      "fields": [
        "user",
        "address",
        "message"
      ],
      "type": "best_fields"
    }
  }
}
```



### 4 prefix查询

```json
# 搜索user字段里以“朝”为开头的所有文档
GET twitter/_search
{
  "query": {
    "prefix": {
      "user": {
        "value": "朝"
      }
    }
  }
}
```



### 5 term查询

term query 会去倒排索引中寻找确切的term，不知道分词器的存在。

- term：查询某个字段里含有某个关键词的文档，类似SQL中的=符号。

- terms：查询某个字段里含有多个关键词的文档，类似SQL中的in符合。

```json
# 搜索user字段为"朝阳区-老贾"文档
GET twitter/_search
{
  "query": {
    "term":{
      "user.keyword":"朝阳区-老贾"
    }
  }
}
```



```json
# 搜索user字段为"朝阳区-老贾"或"双榆树-张三"文档
GET twitter/_search
{
  "query": {
    "terms":{
      "user.keyword":["朝阳区-老贾","双榆树-张三"]
    }
  }
}
```



### 6 must查询

```json
# must，搜索必须是北京的且30岁的文档
GET twitter/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "city": "北京"
          }
        },
        {
          "match": {
            "age": "30"
          }
        }
      ]
    }
  }
}
```



```json
# must_not，搜索不包含北京的文档
GET twitter/_search
{
  "query": {
    "bool": {
      "must_not": [
        {
          "match": {
            "city": "北京"
          }
        }
      ]
    }
  }
}
```



### 7 控制查询返回的文档数量

```json
# from/size 控制查询返回的文档数量
GET twitter/_search
{
 "from":0,
 "size":2,
 "query": {
   "match": {
     "city": "北京"
   }
 }
}
```



### 8 指定返回的字段

```json
# _source 指定返回的字段
GET twitter/_search
{
  "_source":"message",
  "query": {
    "term":{
      "user.keyword":"朝阳区-老贾"
    }
  }
}
```



```json
# excludes 排除返回的字段
GET twitter/_search
{
  "_source":{
    "excludes":"location"
  },
  "query": {
    "term":{
      "user.keyword":"朝阳区-老贾"
    }
  }
}
```



### 9 排序

前缀匹配查询"match_phrase_prefix", 并使用sort实现排序：desc:降序，asc升序

```json
GET twitter/_search
{
    "query": {
        "match_phrase_prefix": {
          "city": "北京"
        }
    },    
    "sort":[
      {
        "age":{"order": "desc"}
      }
      ]
}
```



### 10 范围查询

range:实现范围查询

参数：

- from
- to
- include_lower：是否包含范围的左边界，默认是true
- include_upper：是否包含范围的右边界，默认是true



