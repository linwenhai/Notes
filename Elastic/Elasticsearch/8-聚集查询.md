## 聚集查询

聚集查询（Aggregation）提供针对多条文档的统计运算功能，将文档聚合到一起运算某些方面的特征值。

聚集查询需定义聚集名字（用户自定义）和聚集类型（ES预先定义）。

聚集类型4大类型：

- 指标聚集（Metrics Aggregation），根据文档字段所包含的值运算某些特性值，如平均值、总和等。
- 桶型聚集（Bucket Aggregation），根据一定的分组标准将文档归到不同的组种，这些分组成为桶，类似SQL的group by。
- 管道聚集（Pipeline Aggregation），聚集结果的聚集，以一个聚集的结果为输入，然后再聚集。
- 矩阵聚集（Matrix Aggregation），针对多字段做多种运算，结果类似与矩阵。



### 1 指标聚集

#### 1.1 avg与weighted_avg聚集

```bash
# 参数filter_path=aggregations，过滤掉返回结果其他字段
# 参数delay_avg，自定义的聚集名字
# 参数avg，聚集类型
POST kibana_sample_data_flights/_search?filter_path=aggregations，过滤掉返回结果其他字段
{
  "aggs":{
    "delay_avg":{
      "avg": {
        "field": "FlightDelayMin"
      }
    }
  }
}
```

```bash
# query与aggs同时使用，先运行query，后计算aggs
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "query": {
    "match": {
      "DestCountry": "CN"
    }
  },
  "aggs": {
    "delay_avg": {
      "avg": {
        "field": "FlightDelayMin"
      }
    }
  }
}
```

```bash
# weighted_avg聚集，增加权重
# 参数missing，过滤0值
# if/else，飞行大于120分钟权重为1，小于权重为2
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "delay_avg": {
      "weighted_avg": {
        "value":{
          "field":"FlightDelayMin",
          "missing":0
        },
        "weight":{
          "script":"""
          if(doc.FlightTimeMin.value > 120) 1;
          else 2;
          """
        }
      }
    }
  }
}
```



#### 1.2 value_count与cardinality聚集

value_count聚集：根据某字段统计文档总数，类似count。

cardinality聚集：根据某字段统计文档总数，去重。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "country_code": {
      "cardinality": {
        "field": "DestCountry"
      }
    },
    "country_sum":{
      "value_count": {
        "field": "DestCountry"
      }
    }
  }
}
```



#### 1.3 max与min聚集

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_max": {
      "max": {
        "field": "AvgTicketPrice"
      }
    },
    "price_min":{
      "min": {
        "field": "AvgTicketPrice"
      }
    }
  }
}
```



#### 1.4 stats与extended_stats聚集

stats聚集：返回count、max、min、avg、sum结果

extended_stats聚集：返回count、max、min、avg、sum、平均和、方差、标准方差、标准方差偏移量结果

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_stats": {
      "stats": {
        "field": "AvgTicketPrice"
      }
    }
  }
}
```

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_stats": {
      "extended_stats": {
        "field": "AvgTicketPrice"
      }
    }
  }
}
```



#### 1.5 percentiles与percentile_ranks聚集

percentiles聚集：统计的是百分比与值对应关系，如25%机票价格小于410元

percentile_ranks聚集：统计值与百分比关系，如小于600元的机票占比45%

```bash

POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_per": {
      "percentiles": {
        "field": "AvgTicketPrice",
        "percents": [25,50,75,100]
      }
    },
    "price_per_ranks":{
      "percentile_ranks": {
        "field": "AvgTicketPrice",
        "values": [600,1200]
      }
    }
  }
}
```



### 2 桶型聚集

#### 2.1 range聚集

range聚集：以数值范围分桶，统计文档。

[from,to)：包头不包尾，from类似>=，to类似<

```bash
# 参数ranges设置多个数值范围
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_range": {
      "range": {
        "field": "AvgTicketPrice",
        "ranges": [
          {"to":300},
          {"from":300,"to":600},
          {"from":600,"to":900},
          {"from":900}
        ]
      }
    }
  }
}
```



#### 2.2 date_range聚集

date_range聚集：以日期范围分桶，统计文档。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "mar_flights": {
      "date_range": {
        "field": "timestamp",
        "ranges": [
          {
            "from": "2020-10-26",
            "to": "2020-11-01"
          }
        ],
        "format": "yyyy-MM-dd"
      }
    }
  }
}
```



#### 2.3 ip_range聚集

ip_range聚集：以ip范围分桶，统计文档。

```bash
POST kibana_sample_data_logs/_search?filter_path=aggregations
{
  "aggs": {
    "local": {
      "ip_range": {
        "field": "clientip",
        "ranges": [
          {"from": "116.174.134.1", "to": "116.174.134.255"}
        ]
      }
    }
  }
}
```



#### 2.4 histogram聚集

histogram聚集：以数值为间隔分桶，统计文档。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_histo": {
      "histogram": {
        "field": "AvgTicketPrice",
        "interval": 100
      }
    }
  }
}
```



#### 2.5 date_histogram聚集

date_histogram聚集：以时间为间隔分桶，统计文档。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "month_f": {
      "date_histogram": {
        "field": "timestamp",
        "interval": "month",
        "format": "yyyy-MM"
      }
    }
  }
}
```



#### 2.6 auto_date_histogram聚集

auto_date_histogram聚集：指定分桶数量分桶，统计文档。

```bash
POST kibana_sample_data_flights/_search?size=0
{
  "aggs": {
    "age_group": {
      "auto_date_histogram": {
        "field":"timestamp",
        "buckets":10,
        "format": "yyyy-MM"
      }
    }
  }
}
```



#### 2.7 聚集嵌套

```bash
POST kibana_sample_data_flights/_search?size=0&filter_path=aggregations
{
  "query":{
    "term": {
      "OriginCountry": "CN"
    }
  },
  "aggs": {
    "date_price_histogram": {
      "date_histogram": {
        "field": "timestamp",
        "interval": "month",
        "format": "yyyy-MM"
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "FlightDelayMin"
          }
        }
      }
    }
  }
}
```



#### 2.8 terms聚集

terms聚集：按照词项分桶，统计文档。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "country_1": {
      "terms": {
        "field": "DestCountry",
        "size": 10
      }
    }
  }
}
```



#### 2.9 significant_terms聚集

significant_terms聚集：将文档和词频分为前景集（foreground set）和背景集（background set）。

significant_terms聚集适合做推荐及热词应用。

返回结果参数：

- doc_count为前景集数量
- bg_count为背景集数量

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "query": {
    "term": {
      "OriginCountry": {
        "value": "IE"
      }
    }
  },
  "aggs": {
    "dest": {
      "significant_terms": {
        "field": "DestCountry"
      }
    }
  }
}
```

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "origin_dest": {
      "terms": {
        "field": "OriginCountry"
      },
      "aggs": {
        "dest": {
          "significant_terms": {
            "field": "DestCountry"
          }
        }
      }
    }
  }
}
```



#### 2.10 significant_text聚集

significant_text聚集：参与聚集的文档字段为text类型。

```bash
POST kibana_sample_data_logs/_search?filter_path=aggregations
{
  "query": {
    "term": {
      "response": {
        "value": "200"
      }
    }
  },
  "aggs": {
    "agent_term": {
      "significant_text": {
        "field": "message"
      }
    }
  }
}
```



#### 2.11 diversified_sampler聚集

diversified_sampler聚集：提取样本数量分桶，统计文档。

参数shard_size：样本数量

参数field：过滤条件，AvgTicketPrice过滤相同价格机票

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "query": {
    "term": {
      "OriginCountry": {
        "value": "IE"
      }
    }
  },
  "aggs": {
    "sample_data": {
      "diversified_sampler": {
        "shard_size": 100,
        "field": "AvgTicketPrice"
      },
      "aggs": {
        "dest_country": {
          "significant_terms": {
            "field": "DestCountry"
          }
        }
      }
    }
  }
}
```



#### 2.12 filter与filters聚集

filter聚集：单通型过滤器聚集

filters聚集：多桶型过滤器聚集

```bash
POST kibana_sample_data_flights/_search?size=0&filter_path=aggregations
{
  "aggs": {
    "origin_cn": {
      "filter": {
        "term": {
          "OriginCountry": "CN"
        }
      },
      "aggs": {
        "cn_price": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}
```

```bash
POST kibana_sample_data_flights/_search?size=0&filter_path=aggregations
{
  "aggs": {
    "origin_cn_us": {
      "filters": {
        "filters": [
          {
            "term":{"OriginCountry":"CN"}
          },
          {
            "term":{"OriginCountry":"US"}
          }
        ]
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}
```



#### 2.13 global聚集

global聚集：把索引所有文档归入一个桶中，在和query结合使用，不受query影响。

```bash
POST kibana_sample_data_flights/_search?size=0&filter_path=aggregations
{
  "query": {
    "term": {
      "Carrier": {
        "value": "Kibana Airlines"
      }
    }
  },
  "aggs": {
    "kibana_avg": {
      "avg": {
        "field": "FlightDelayMin"
      }
    },
    "all_flights":{
      "global": {},
      "aggs": {
        "all_avg": {
          "avg": {
            "field": "FlightDelayMin"
          }
        }
      }
    }
  }
}
```



#### 2.14 missing聚集

missing聚集：将缺失字段的文档归入一通。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "no_price": {
      "missing": {
        "field": "AvgTicketPrice"
      }
    }
  }
}
```



#### 2.15 composite聚集

composite聚集：将不同类型的聚集组合一起。

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "price_weather": {
      "composite": {
        "sources": [
          {"avg_price":{"histogram":{"field":"AvgTicketPrice","interval": 500}}},
          {"weather":{"terms":{"field":"OriginWeather"}}}
        ]
      }
    }
  }
}
```



#### 2.16 adjacency_matrix聚集

adjacency_matrix聚集：邻接矩阵聚集。

```bash
POST kibana_sample_data_flights/_search?size=0&filter_path=aggregations
{
  "aggs": {
    "age_group": {
      "adjacency_matrix": {
        "filters": {
          "F1":{
            "term":{"DestCountry":"AU"}
          },
          "F2":{
            "term":{"DestWeather":"Rain"}
          },
          "F3":{
            "term":{"FlightDelay":false}
          }
        }
      }
    }
  }
}
```



### 3 管道聚集

#### 3.1 avg_bucket聚集

avg_bucket聚集：

```bash
POST kibana_sample_data_flights/_search?filter_path=aggregations
{
  "aggs": {
    "ca": {
      "terms": {
        "field": "Carrier",
        "size": 10
      },
      "aggs": {
        "ca_stat": {
          "stats": {
            "field": "AvgTicketPrice"
          }
        }
      }
    },
    "all_stat":{
      "avg_bucket": {
        "buckets_path": "ca>ca_stat.avg"
      }
    }
  }
}
```

