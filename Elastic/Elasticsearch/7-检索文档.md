## 检索文档

### 1 term查询

term查询：对单个字段做词项值的精准匹配，基于词项的查询。

- term：只能匹配一个词项，类似SQL中的=操作符。
- terms：可以匹配多个词项，类似SQL中的in操作符。
- terms_set：类似terms，匹配字段类型是数组。

```bash
# term查询
POST kibana_sample_data_flights/_search
{
  "query": {
    "term":{"OriginCountry":"CN"}
  }
}
 
# terms查询
POST kibana_sample_data_flights/_search
{
  "query": {
    "terms":{"OriginCountry":["CN","US"]}
  }
}
 
# terms_set查询
POST kibana_sample_data_logs/_search
{
  "query": {
    "terms_set":{
      "tags":{
        "terms":["success","info"],
        "minimum_should_match_script":{"source":"2"}
      }
    }
  }
}
```



### 2 range查询

ange查询：实现范围查询，使用场景有数值、日期等，基于词项的查询。

| 参数 |      |
| ---- | ---- |
| gte  | >=   |
| gt   | >    |
| lte  | <=   |
| lt   | <    |

```bash
# range查询
POST kibana_sample_data_flights/_search
{
  "query": {
    "range":{
      "FlightDelayMin": {
        "gte": 100,
        "lte": 200
      }
    }
  }
}
```



### 3 exists查询

exists查询：用于查询指定字段不为空的文档 ，基于词项的查询。

```bash
# exists查询
POST kibana_sample_data_flights/_search
{
  "query": {
    "exists": {"field": "DestCountry"}
  }
}
```



### 4 prefix查询

prefix查询：查询字段值包含指定前缀的文档，基于词项的查询。

```bash
# 查询字段前缀为mo文档
POST kibana_sample_data_logs/_search
{
  "query": {
    "prefix": {"message":"mo"}
  }
}
```



### 5 wildcard查询

wildcard查询：允许在字段查询中使用通配符"*"和"?"，基于词项的查询。

使用wildcard查询尽量不要用通配符放置第一位。

```bash
# 查询字段message匹配firefox
POST kibana_sample_data_logs/_search
{
  "query": {
    "wildcard": {"message":"f*f?x"}
  }
}
```



### 6 regexp查询

regexp查询：允许查询条件中使用正则表达式与字段匹配，基于词项的查询。

```bash
# 匹配firefox
POST kibana_sample_data_logs/_search
{
  "query": {
    "regexp": {"message":"f.*f.x"}
  }
}
```



### 7 match查询

match查询：只接收文本、数值、日期类型，如词项为多个，词项与词项之间匹配结果按布尔或运算，基于全文的查询。

```bash
# match查询，firefox与chrome只要有一个匹配成功就为返回文档
POST kibana_sample_data_logs/_search
{
  "query": {
    "match":{"message":"firefox chrome"}
  }
}
 
# 参数operator=and，firefox与chrome同时匹配成功才为返回文档
POST kibana_sample_data_logs/_search
{
  "query": {
    "match":{
      "message":{
        "query": "firefox chrome",
        "operator": "and"
      }
    }
  }
}

# match_all查询全部文档
POST kibana_sample_data_logs/_search
{
  "query": {
    "match_all": {}
  }
}
```



### 8 multi_match查询

multi_match查询：与match查询类似，可对多个字段同时匹配，基于全文的查询。

```bash
# multi_match查询，匹配多个字段
POST kibana_sample_data_flights/_search
{
  "_source": ["OriginCountry","DestCountry"],
  "query": {
    "multi_match": {
      "query": "AT",
      "fields": ["OriginCountry","DestCountry"]
    }
  }
}
```



### 9 match_phrase查询

match_phrase查询：查询条件需在字段依次出现，并紧挨的才匹配（短语匹配），基于全文的查询。

match_phrase_prefix查询：基于短语前缀匹配。

```bash
# match_phrase查询，类似短语匹配
POST kibana_sample_data_logs/_search
{
  "_source": "message", 
  "query": {
    "match_phrase":{
      "message": "Mozilla/5.0"
    }
  }
}
 
# match_phrase_prefix查询，基于短语前缀匹配
POST kibana_sample_data_logs/_search
{
  "_source": "message", 
  "query": {
    "match_phrase_prefix":{
      "message": "Mozilla/5.0"
    }
  }
}
```



### 10 query_string查询

query_string查询：查询条件为字符串，基于全文的查询。

simple_query_string查询：query_string查询简化版。

```bash
# query_string 字符串查询
POST kibana_sample_data_logs/_search
{
  "_source": "message", 
  "query": {
    "query_string": {
      "default_field":"message",
      "query": "(Chrome 11.0.696.50) AND (Safari 534.24)"
    }
  }
}

# simple_query_string，字符串查询简化版
POST kibana_sample_data_logs/_search
{
  "_source": "message", 
  "query": {
    "simple_query_string": {
      "fields":["message"],
      "query": "(Chrome 11.0.696.50) + (Safari 534.24)"
    }
  }
}
```



### 11 模糊查询

Elasticsearch模糊查询主要使用 Levenshtein 和 NGram 算法实现的。

Levenshtein算法：定义了4种字符操作，即替换、插入、删除、换位，每执行一次操作编辑距离就+1，编辑距离越大，说明两字符串之间差异越大，编辑距离还与字符串长度相关，适用于对单个词项的模糊查询。

NGram算法：让字符串分解为NGram，然后比较分解后共有NGram的数量，适用于对多个词项匹配。

| 参数                 |                                           |
| -------------------- | ----------------------------------------- |
| fuzziness            | 设置编辑距离长度                          |
| fuzzy_transpositions | 定义模糊查询是否允许换位操作，默认为false |
| prefix_length        | 定义模糊处理的前缀长度，默认为0           |
| max_expansions       | 定义模糊匹配结果的最大数量，默认为50      |

```bash
# fuzzy模糊查询，基于词项的
POST kibana_sample_data_logs/_search
{
  "query": {
    "fuzzy": {
      "message": {
        "value": "firefix",
        "fuzziness": 1
      }
    }
  }
}

# match模糊查询，基于全文的
POST kibana_sample_data_logs/_search
{
  "query": {
    "match": {
      "message": {
        "query": "firefit",
        "fuzziness": "AUTO:3,6",
        "fuzzy_transpositions": "true",
        "prefix_length": 4,
        "max_expansions": 10
      }
    }
  }
}

# multi_match模糊查询，基于全文的
POST kibana_sample_data_logs/_search
{
  "query": {
    "multi_match": {
      "query": "firefix",
      "fields": ["message","agent"],
      "fuzziness": "AUTO",
      "fuzzy_transpositions": "true",
      "prefix_length": 4,
      "max_expansions": 10
    }
  }
}

# query_string模糊查询，基于全文的
POST kibana_sample_data_logs/_search
{
  "query": {
    "query_string": {
      "default_field": "message",
      "query": "firefit ~",
      "fuzziness": "AUTO:3,6",
      "fuzzy_max_expansions": 50,
      "fuzzy_prefix_length": 4
    }
  }
}
```





