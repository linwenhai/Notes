## 架构原理

#### 1 大规模数据如何检索

如：当系统数据量上了10亿、100亿条的时候，我们在做系统架构的时候通常会从以下角度去考虑问题：
1】用什么数据库好？(mysql、sybase、oracle、达梦、神通、mongodb、hbase…)
2】如何解决单点故障？(lvs、F5、A10、Zookeep、MQ)
3】如何保证数据安全性？(热备、冷备、异地多活)
4】如何解决检索难题？(数据库代理中间件：mysql-proxy、Cobar、MaxScale等;)
5】如何解决统计分析问题？(离线、近实时)



#### 2 传统数据库的应对解决方案

对于关系型数据，我们通常采用以下或类似架构去解决查询瓶颈和写入瓶颈：
解决要点：
1】通过主从备份解决数据安全性问题；
2】通过数据库代理中间件心跳监测，解决单点故障问题；
3】通过代理中间件将查询语句分发到各个slave节点进行查询，并汇总结果。



#### 3 非关系型数据库的解决方案

对于Nosql数据库，以mongodb为例，其它原理类似：
解决要点：
1】通过副本备份保证数据安全性；
2】通过节点竞选机制解决单点问题；
3】先从配置库检索分片信息，然后将请求分发到各个节点，最后由路由节点合并汇总结果。



#### 4 Elasticsearch定义

ES=elaticsearch简写， Elasticsearch是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。

Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。



#### 5 Elasticsearch优点

1】分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。
2】准实时分析的分布式搜索引擎。
3】可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。
4】支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。



#### 6 Elasticsearch应用场景

**场景一**：将Elasticsearch作为网站的主要后端系统

Elasticsearch是提供持久存储、统计等多项功能的现代搜索引擎。
如果你开始一个新项目，我们建议您考虑使用Elasticsearch作为唯一的数据存储，以帮助保持你的设计尽可能简单。
此种场景不支持包含频繁更新、事务（transaction）的操作。

例子：新建一个博客系统使用es作为存储。
1】我们可以向ES提交新的博文。
2】使用ES检索、搜索、统计数据。

![这里写图片描述](d:\user\835084\desktop\1.png)



**场景二**：将Elasticsearch添加到现有的系统

由于ES不能提供存储的所有功能，一些场景下需要在现有系统数据存储的基础上新增ES支持。

例子：如果你已经有一个在运行的复杂的系统，你的需求之一是在现有系统中添加检索服务。将ES作为新的组件添加到现有系统中，选择的插件使得两存储之间实时同步。

可供选择的插件包括：
1】mysql、oracle选择 logstash-input-jdbc 插件。
2】mongo选择 mongo-connector工具。

![这里写图片描述](d:\user\835084\desktop\2.png)



关系型&非关系型数据库与ES如何同步？

![这里写图片描述](d:\user\835084\desktop\3.png)



**场景三**：使用elasticsearch和现有的工具

例子：ELK日志系统

![这里写图片描述](d:\user\835084\desktop\4.png)







#### 7 数据引擎排名

https://db-engines.com/en/ranking

![image-20201030205622804](d:\user\835084\desktop\5.png)





#### 8 容量预估

总数据量（GB） = 原始数据量（GB） /每天 X 保留天数 X 净膨胀系数 X （副本 + 1）

磁盘存储（GB） = 总数据量（GB）* ( 1 + 0.15 + 0.05)

数据节点 = 向上取证（磁盘存储（GB）/ 每个数据节点的内存量 / 内存：数据比率）+ 1

Tips：腾讯云 在 2019 4 月的 meetup 分享中建议：磁盘容量大小 = 原始数据大小 * 3.38。



1个集群支持20个系统接入，每个系统预估每天产生30G日志，日志数据默认保留15天，日志数据默认保留1个副本
日志数据量数据的大小为：20*30*15*2=12000G
预留 15%警戒磁盘水位空间。
为错误余量和后台活动预留+ 5％。
保留等效的数据节点以处理故障。
磁盘存储（GB） = 总数据量（GB）* ( 1 + 0.15 + 0.05) = 12000*1.2=14400G=14.4T



