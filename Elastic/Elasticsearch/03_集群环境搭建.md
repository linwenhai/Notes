## Elasticsearch7.2.1环境搭建

#### 1 ES获取

elasticsearch-7.2.1-linux-x86_64.tar.gz

```bash
curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.2.1-linux-x86_64.tar.gz
```



#### 2 OS配置

```bash
ulimit -n
vi /etc/security/limits.conf
```

>#添加内容
>
>*              soft    nproc   65535
>*              hard    nproc   65535
>*              soft    nofile  65535
>*              hard    nofile  65535

```bash
vi /etc/sysctl.conf
```

>#添加内容
>
>vm.max_map_count=262144

```bash
sysctl -p
```



#### 3 ES配置

1】证书

如下操作在其中一个node节点执行即可，生成完证书传到集群其他节点目录/opt/elasticsearch/config。

两条命令均一路回车即可，不需要给秘钥再添加密码。

```bash
cd /opt/elasticsearch/config
../bin/elasticsearch-certutil ca
../bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
```



2】elasticsearch.yml

各节点除了node.name使用各自主机名之外，其他配置都一样。

```yml
cluster.name: es-test
node.name: node-1
path.data: /opt/elasticsearch/data
path.logs: /opt/elasticsearch/logs
network.host: 192.168.100.11
http.port: 9200
discovery.seed_hosts: ["192.168.100.11", "192.168.100.12", "192.168.100.13"]
cluster.initial_master_nodes: ["node-01","node-02","node-03"]
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/elastic-certificates.p12
```



#### 4 jvm.options

```bash
vi /opt/elasticsearch/config/jvm.options
```

>#修改内容
>
>-Xms30g 
>-Xmx30g 
>#-XX:+UseConcMarkSweepGC
>-XX:+UseG1GC



#### 5 启动关闭

```bash
cd /app/elasticsearch/bin
./elasticsearch -d
 
ps -ef|grep elasticsearch|awk '{print $2}'|xargs kill -9
```



#### 6 为内置账号添加密码

```bash
# 参数interactive：给用户一一设置密码，auto：自动生成密码
bin/elasticsearch-setup-passwords interactive
```

```bash
interactive
Initiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.
You will be prompted to enter passwords as the process progresses.
Please confirm that you would like to continue [y/N]y

Enter password for [elastic]: 
Reenter password for [elastic]: 
Enter password for [apm_system]: 
Reenter password for [apm_system]: 
Enter password for [kibana]: 
Reenter password for [kibana]: 
Enter password for [logstash_system]: 
Reenter password for [logstash_system]: 
Enter password for [beats_system]: 
Reenter password for [beats_system]: 
Enter password for [remote_monitoring_user]: 
Reenter password for [remote_monitoring_user]: 
Changed password for user [apm_system]
Changed password for user [kibana]
Changed password for user [logstash_system]
Changed password for user [beats_system]
Changed password for user [remote_monitoring_user]
Changed password for user [elastic]
```



#### 7 集群健康检查

```bash
curl -XGET "http://10.110.39.241:9200/_cluster/health"
```

```bash
curl -XGET "http://10.110.39.241:9200/_cat/health?v"
```



#### 8 日志索引清除

delete_es_index.sh

```bash
#/bin/bash
#es-index-clear
#只保留7天内的日志索引
LAST_DATA=`date -d "-8 days" "+%Y.%m.%d"`
curl -XDELETE 'http://10.119.97.210:9200/*-'${LAST_DATA}'*'
```

