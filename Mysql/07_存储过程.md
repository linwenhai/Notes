## 存储过程

存储过程和函数是事先经过编译并存储在数据库中的一段SQL语句的集合。



### 1 创建存储过程

```sql
CREATE
    [DEFINER = { user | CURRENT_USER }]
　PROCEDURE sp_name ([proc_parameter[,...]])
    [characteristic ...] routine_body
 
proc_parameter:
    [ IN | OUT | INOUT ] param_name type
 
characteristic:
    COMMENT 'string'
  | LANGUAGE SQL
  | [NOT] DETERMINISTIC
  | { CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA }
  | SQL SECURITY { DEFINER | INVOKER }
 
routine_body:
　　Valid SQL routine statement
 
[begin_label:] BEGIN
　　[statement_list]
　　　　……
END [end_label]
```



### 2 声明语句结束符

```sql
---修改语句结束符“;”改为"$$"或“//”
DELIMITER $$
或
DELIMITER //

---恢复语句结束符为“;”，在存储过程创建完成后执行
DELIMITER
```



### 3 声明存储过程

```sql
CREATEPROCEDURE 存储过程名([[IN |OUT |INOUT ] 参数名 数据类形...])
```

- IN 输入参数：表示调用者向过程传入值（传入值可以是字面量或变量）
- OUT 输出参数：表示过程向调用者传出值(可以返回多个值)（传出值只能是变量）

```sql
 create procedure in_param(in p_in int)
 create procedure out_param(out p_out int)
```



### 4 存储过程开始和结束符号

```sql
BEGIN
　　BEGIN
　　　　BEGIN
　　　　　　statements; 
　　　　END
　　END
END
```



### 5 定义变量和赋值

语法：

```
DECLAREvariable_name [,variable_name...] datatype [DEFAULT value];
```

```
SET 变量名 = 表达式值 [,variable_name = expression ...]
```



```sql
---变量定义
declare p_int int; 

---使用set变量赋值
set @p_in=1  

---使用查询变量赋值
select ifnull(sum(p.amount),0) into v_payment;
```



### 6 定义条件和处理

```sql
declare continue handler for sqltate '23000' set @x2=1;
```



### 7 创建存储过程实例

```sql
---新建测试表ts1
mysql> create table ts1(playerno int(10),won int(10),lost int(10));
---插入测试数据
mysql> insert into ts1 value(6,3,1);
mysql> insert into ts1 value(57,3,0);
mysql> insert into ts1 value(8,0,3);
mysql> insert into ts1 value(27,3,2);
mysql> insert into ts1 value(112,2,3);

---创建存储过程
mysql> delimiter $$
mysql> 
create procedure del_no(in p_playerno int)
begin
	delete from ts1 where playerno=p_playerno;
end $$
mysql> delimiter ;

---调用存储过程
mysql> select * from ts1;
+----------+------+------+
| playerno | won  | lost |
+----------+------+------+
|        6 |    3 |    1 |
|       57 |    3 |    0 |
|        8 |    0 |    3 |
|       27 |    3 |    2 |
|      112 |    2 |    3 |
+----------+------+------+

mysql> call del_no(57);
mysql> select * from ts1;
+----------+------+------+
| playerno | won  | lost |
+----------+------+------+
|        6 |    3 |    1 |
|        8 |    0 |    3 |
|       27 |    3 |    2 |
|      112 |    2 |    3 |
+----------+------+------+
```



### 8 删除存储过程

```sql
mysql> drop procedure del_no;
Query OK, 0 rows affected (0.01 sec)
```



### 9 查看存储过程

```sql
mysql> show procedure status like 'del_no' \G
*************************** 1. row ***************************
                  Db: test1
                Name: del_no
                Type: PROCEDURE
             Definer: root@localhost
            Modified: 2019-09-21 22:39:18
             Created: 2019-09-21 22:39:18
       Security_type: DEFINER
             Comment: 
character_set_client: gb2312
collation_connection: gb2312_chinese_ci
  Database Collation: utf8mb4_general_ci
```



### 10 查看存储过程定义

```sql
mysql> show create procedure del_no \G
*************************** 1. row ***************************
           Procedure: del_no
            sql_mode: ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
    Create Procedure: CREATE DEFINER=`root`@`localhost` PROCEDURE `del_no`(in p_playerno int)
begin
delete from ts1 where playerno=p_playerno;
end
character_set_client: gb2312
collation_connection: gb2312_chinese_ci
  Database Collation: utf8mb4_general_ci
```



### 11 流程控制

#### 1】if语句与case语句

语法：

```sql
if
	...
end if;
```



```sql
if i_id = 2 then
	set @x1 = @x1 + d_amount;
else
	set @x2 = @x2 + d_amount;
end if;
```



语法：

```sql
case [case_value]
	...
end case;
```



```sql
case
	when i_id = 2 then
		set @x1 = @x1 + d_amount;
	else
		set @x2 = @x2 + d_amount;
end case;
```

```sql
case i_id
	when 2 then
		set @x1 = @x1 + d_amount;
	else
		set @x2 = @x2 + d_amount;
end case;
```



#### 2】loop语句和leave语句

loop循环需要leave实现退出。

```sql
ins:loop
	set @x = @x + 1;
	if @x = 100 then
	leave ins;
	end if;
	insert into actor(first_name,last_name) value('lin','hai');
end loop ins;	
```



#### 3】iterate语句

iterate语句必须使用在循环中，作用是跳过当前循环的剩下语句，执行下一轮循环。

```sql
ins:loop
	set @x = @x + 1;
	if @x = 10 then
	leave ins;
	elseif mod(@x,2) = 0 then
	iterate ins;
	end if;
	insert into actor(first_name,last_name) value('lin','hai');
end loop ins;	
```



#### 4】repeat语句

`repeat`语句当满足条件的时候退出循环。

```
repeat
	fetch c_payment into i_id,d_amount;
	if i_id = 2 then
		set @x1 = @x1 + d_amount;
	else
		set @x2 = @x2 + d_amount;
	end if;
until 0 end repeat;
```



#### 5】while语句

while语句当满足条件的时候执行循环。

```sql
while @x1 < 0 do
	set @x1 = @x1 + 1;
end while;
```



### 12 调度器

```sql
---创建测试表test
mysql> create table test(name varchar(10),c_time datetime);
Query OK, 0 rows affected (0.01 sec)

---创建调节器test_event_1
mysql>
create event test_event_1
on schedule
every 5 second
do
insert into test1.test(name,c_time) value('test',now());

---查看调节器状态
mysql> show events \G
*************************** 1. row ***************************
                  Db: test1
                Name: test_event_1
             Definer: root@localhost
           Time zone: SYSTEM
                Type: RECURRING
          Execute at: NULL
      Interval value: 5
      Interval field: SECOND
              Starts: 2019-09-23 21:30:18
                Ends: NULL
              Status: ENABLED
          Originator: 1
character_set_client: gb2312
collation_connection: gb2312_chinese_ci
  Database Collation: utf8mb4_general_ci

---调节器，默认是关闭的
mysql> show variables like '%scheduler%';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| event_scheduler | OFF   |
+-----------------+-------+

---打开调节器
mysql> set global event_scheduler=1;
Query OK, 0 rows affected (0.00 sec)
mysql> show variables like '%scheduler%';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| event_scheduler | ON    |
+-----------------+-------+

---查看后台进程
mysql> show processlist \G
*************************** 1. row ***************************
     Id: 3
   User: root
   Host: localhost
     db: test1
Command: Query
   Time: 0
  State: starting
   Info: show processlist
*************************** 2. row ***************************
     Id: 4
   User: event_scheduler
   Host: localhost
     db: NULL
Command: Daemon
   Time: 0
  State: Waiting for next activation
   Info: NULL


---创建调节器trunc_test
mysql>
create event trunc_test
on schedule every 1 minute
do 
truncate table test;

---禁用调度器test_event_1
mysql> alter event test_event_1 disable;
Query OK, 0 rows affected (0.01 sec)

---删除调度器test_event_1
mysql> drop event test_event_1;
Query OK, 0 rows affected (0.01 sec)
```



